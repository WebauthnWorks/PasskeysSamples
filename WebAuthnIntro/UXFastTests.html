<!DOCTYPE html>
<html>
<head>
    <title>Awesome Store</title>
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@2.6.0/dist/full.css" rel="stylesheet" type="text/css"/>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 text-white">
    <main class="max-w-7xl mx-auto flex flex-row">
        <!-- Left: Controls -->
        <section class="basis-1/2 flex p-4 m-3 rounded-lg shadow-lg mt-8 mr-6 text-black bg-white">
            <div class="min-w-full">
                <h1 class="text-xl mb-4">Make Credential</h1>
                <div class="p-4">
                    <div class="flex items-center">
                        <button type="submit" class="m-4 bg-green-500 text-white p-4 w-full rounded-lg" onclick="makeCredsSample()">Basic MakeCredential</button>
                    </div>
                    <div class="flex flex-row">
                        <div class="basis-1/2 flex items-center"> 
                            <button type="submit" class="m-4 bg-green-500 text-white p-4 w-full rounded-lg" onclick="makeCredential_Platform()">MakeCred Platform</button>
                        </div>
                        <div class="basis-1/2 flex items-center">
                            <button type="submit" class="m-4 bg-green-500 text-white p-4 w-full rounded-lg" onclick="makeCredential_CrossPlatform()">MakeCred Cross Platform</button>
                        </div>
                    </div>
                    <div class="flex flex-row">
                        <div class="basis-1/2 flex items-center">
                            <button type="submit" class="m-4 bg-green-500 text-white p-4 w-full rounded-lg" onclick="makeCredential_SecurityKey()">MakeCred Force Security Key</button>
                        </div>
                        <div class="basis-1/2 flex items-center"> 
                            <button type="submit" class="m-4 bg-green-500 text-white p-4 w-full rounded-lg" onclick="makeCredential_HybridEnforced()">MakeCred Force Hybrid CaBLE</button>
                        </div>
                    </div>
                </div>

                <h1 class="text-xl mb-4 mt-5">Get Assertion (Run "Basic MakeCred" First)</h1>
                <div class="p-4">
                    <div class="flex items-center">
                        <button type="submit" class="m-4 bg-green-500 text-white p-4 w-full rounded-lg" onclick="getAssertionSample()">Basic GetAssertion</button>
                    </div>
                    <div class="flex flex-row">
                        <div class="basis-1/2 flex items-center">
                            <button type="submit" class="m-4 bg-green-500 text-white p-4 w-full rounded-lg" onclick="getAssertion_SecurityKey()">GetAssertion Force Security Key</button>
                        </div>
                        <div class="basis-1/2 flex items-center"> 
                            <!-- Fixed: this now calls getAssertion_Platform -->
                            <button type="submit" class="m-4 bg-green-500 text-white p-4 w-full rounded-lg" onclick="getAssertion_Platform()">GetAssertion Force Platform</button>
                        </div>
                    </div>
                    <div class="flex flex-row">
                        <div class="basis-1/2 flex items-center">
                            <button type="submit" class="m-4 bg-green-500 text-white p-4 w-full rounded-lg" onclick="getAssertion_RKEnforced()">GetAssertion Force RK</button>
                        </div>
                        <div class="basis-1/2 flex items-center">
                            <button type="submit" class="m-4 bg-blue-500 text-white p-4 w-full rounded-lg" onclick="getAssertion_StartConditionalFlow()">Enable Conditional UI</button>
                        </div>
                    </div>
                    <div class="flex items-center p-4">
                        <label class="block min-w-full">
                            <span class="after:content-['*'] after:ml-0.5 after:text-red-500 block text-sm font-medium text-slate-700">
                                Conditional UI (press "Enable Conditional UI" to start)
                            </span>
                            <input type="email" name="email" class="mt-1 px-3 py-2 bg-white border shadow-sm border-slate-300 placeholder-slate-400 focus:outline-none focus:border-sky-500 focus:ring-sky-500 block w-full rounded-md sm:text-sm focus:ring-1" autocomplete="webauthn" placeholder="you@example.com" />
                        </label>
                    </div>
                </div>
            </div>
        </section>

        <!-- Right: Payload / Response Panel -->
        <section class="basis-1/2 p-4 m-3 rounded-lg shadow-lg mt-8 bg-slate-900 text-slate-100 flex flex-col">
            <h2 class="text-lg font-semibold mb-4">WebAuthn Debug</h2>
            <div class="flex-1 flex flex-col mb-4">
            <label for="sentPayload" class="block text-sm font-medium mb-1 text-slate-200">
                Sent Payload
            </label>
            <textarea
                id="sentPayload"
                class="w-full flex-1 rounded-md bg-slate-800 text-xs font-mono p-2 border border-slate-700 resize"
                placeholder="PublicKey options sent to navigator.credentials.create()/get() will appear here..."
                spellcheck="false"
            ></textarea>
            </div>
            <div class="flex-1 flex flex-col">
            <label for="receivedResponse" class="block text-sm font-medium mb-1 text-slate-200">
                Received Response
            </label>
            <textarea
                id="receivedResponse"
                class="w-full flex-1 rounded-md bg-slate-800 text-xs font-mono p-2 border border-slate-700 resize"
                placeholder="Credential / assertion result will appear here..."
                spellcheck="false"
            ></textarea>
            </div>
        </section>
    </main>

    <script>
    /* ----- MakeCredential ----- */
        var makeCredsSample = () => {
            publicKey = generateMakeCredParams();
            
            return executeMakeCredential(publicKey, true)
            .then((credResp) => {
                window.validCredID = credResp.authData.credID
            })
        }

        var makeCredential_SecurityKey = () => {
            publicKey = generateMakeCredParams();
            
            publicKey.authenticatorSelection = {
                "authenticatorAttachment": "cross-platform"
            }

            publicKey.hints = ["security-key"]

            return executeMakeCredential(publicKey, true)
        }

        var makeCredential_HybridEnforced = () => {
            publicKey = generateMakeCredParams();
            
            publicKey.authenticatorSelection = {
                "authenticatorAttachment": "cross-platform"
            }

            publicKey.hints = ["hybrid"]

            return executeMakeCredential(publicKey, true)
        }

        var makeCredential_CrossPlatform = () => {
            publicKey = generateMakeCredParams();
            
            publicKey.authenticatorSelection = {
                "authenticatorAttachment": "cross-platform"
            }

            return executeMakeCredential(publicKey, true)
        }

        var makeCredential_Platform = () => {
            publicKey = generateMakeCredParams();
            
            publicKey.authenticatorSelection = {
                "authenticatorAttachment": "platform"
            }

            publicKey.hints = ["client-device"]

            return executeMakeCredential(publicKey, true)
        }
    /* ----- MakeCredential Ends----- */


    /* ----- GetAssertion ----- */
        var getAssertionSample = () => {
            var publicKey = generateGetAssertion()
            publicKey.allowCredentials = [
                { type: "public-key", id: window.validCredID }
            ]

            return executeGetAssertion(publicKey)
        }

        var getAssertion_SecurityKey = () => {
            var publicKey = generateGetAssertion(true)
            publicKey.allowCredentials = [
                { type: "public-key", id: window.validCredID, transports: ["cross-platform"]}
            ]

            publicKey.hints = ["security-key"]

            return executeGetAssertion(publicKey, true)
        }

        var getAssertion_Platform = () => {
            var publicKey = generateGetAssertion()
            publicKey.allowCredentials = [
                { type: "public-key", id: window.validCredID, transports: ["internal"]}
            ]

            publicKey.hints = ["client-device"]

            return executeGetAssertion(publicKey, true)
        }

        var getAssertion_RKEnforced = () => {
            var publicKey = generateGetAssertion()

            return executeGetAssertion(publicKey, true)
        }

        var getAssertion_StartConditionalFlow = () => {
            if (!PublicKeyCredential.isConditionalMediationAvailable ||
                !PublicKeyCredential.isConditionalMediationAvailable()) {
                return alert("Conditional UI is not supported on this browser.")
            }

            var publicKey = generateGetAssertion()

            return executeGetAssertion(publicKey, true, true)
        }
    /* ----- GetAssertion Ends----- */
    </script>

    <script src="../lib/base64url-arraybuffer.js"></script>
    <script src="../lib/cbor.js"></script>
    <script src="../lib/helpers.js"></script>

    <!-- Logging wrapper: shows sent options + responses in the right panel -->
<!-- Logging wrapper: shows sent options + responses in the right panel -->
<script>
    (function () {
        const sentEl = document.getElementById("sentPayload");
        const respEl = document.getElementById("receivedResponse");

        if (!window.executeMakeCredential || !window.executeGetAssertion) {
            // helpers.js not loaded or API changed
            return;
        }

        const originalExecuteMakeCredential = window.executeMakeCredential;
        const originalExecuteGetAssertion = window.executeGetAssertion;

        function encodeBytes(value) {
            // Try to use base64url-arraybuffer if available
            try {
                if (typeof base64url !== "undefined" && typeof base64url.encode === "function") {
                    let ab;

                    if (value instanceof ArrayBuffer) {
                        ab = value;
                    } else if (ArrayBuffer.isView(value)) {
                        const u8 = new Uint8Array(value.buffer, value.byteOffset, value.byteLength);
                        ab = u8.buffer.slice(u8.byteOffset || 0, (u8.byteOffset || 0) + u8.byteLength);
                    } else {
                        return String(value);
                    }

                    const b64 = base64url.encode(ab);
                    return `base64url:${b64} (${ab.byteLength} bytes)`;
                }
            } catch (e) {
                // fall through
            }

            // Fallback if base64url is not available
            const len = value && value.byteLength ? value.byteLength : "?";
            return `TypedArray(${len} bytes)`;
        }

        function safeStringify(value) {
            try {
                return JSON.stringify(
                    value,
                    function (_key, val) {
                        // Binary blobs â†’ base64url
                        if (val instanceof ArrayBuffer || ArrayBuffer.isView(val)) {
                            return encodeBytes(val);
                        }

                        // Light handling for PublicKeyCredential objects
                        if (
                            val &&
                            typeof val === "object" &&
                            val.constructor &&
                            val.constructor.name === "PublicKeyCredential"
                        ) {
                            return {
                                id: val.id,
                                type: val.type,
                                rawId: val.rawId ? encodeBytes(val.rawId) : undefined,
                                responseType:
                                    val.response && val.response.constructor
                                        ? val.response.constructor.name
                                        : undefined,
                                // You can add more fields if you want:
                                // clientDataJSON: val.response?.clientDataJSON && encodeBytes(val.response.clientDataJSON),
                                // authenticatorData: val.response?.authenticatorData && encodeBytes(val.response.authenticatorData),
                                // signature: val.response?.signature && encodeBytes(val.response.signature),
                                // userHandle: val.response?.userHandle && encodeBytes(val.response.userHandle),
                            };
                        }

                        return val;
                    },
                    2
                );
            } catch (e) {
                return String(value);
            }
        }

        window.executeMakeCredential = function (publicKey, skipAlert) {
            if (sentEl) {
                sentEl.value = safeStringify(publicKey);
            }

            const result = originalExecuteMakeCredential.call(this, publicKey, skipAlert);

            if (result && typeof result.then === "function") {
                return result.then(function (res) {
                    if (respEl) {
                        respEl.value = safeStringify(res.makeCredResp);
                    }
                    return res;
                });
            } else {
                if (respEl) {
                    respEl.value = safeStringify(result);
                }
                return result;
            }
        };

        window.executeGetAssertion = function (publicKey, skipAlert, useConditional) {
            if (sentEl) {
                sentEl.value = safeStringify(publicKey);
            }

            const result = originalExecuteGetAssertion.call(
                this,
                publicKey,
                skipAlert,
                useConditional
            );

            if (result && typeof result.then === "function") {
                return result.then(function (res) {
                    if (respEl) {
                        respEl.value = safeStringify(res);
                    }
                    return res;
                });
            } else {
                if (respEl) {
                    respEl.value = safeStringify(result);
                }
                return result;
            }
        };
    })();
</script>

</body>
</html>
